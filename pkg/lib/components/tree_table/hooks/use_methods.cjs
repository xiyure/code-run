"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("../../../node_modules/vue/dist/vue.runtime.esm-bundler.cjs");const V=require("../../../node_modules/@vue/shared/dist/shared.esm-bundler.cjs"),he=require("../model/tree_store.cjs"),L=require("../../../utils/utils.cjs");require("../../../node_modules/resize-observer-polyfill/dist/ResizeObserver.es.cjs");require("../../../node_modules/sortablejs/modular/sortable.esm.cjs");require("../../../node_modules/culori/src/index.cjs");const me=require("../../../constant/filter_data.cjs"),ge=require("../../../node_modules/@vue/reactivity/dist/reactivity.esm-bundler.cjs"),G=require("../../../node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.cjs");function ye(f,u){const A={data:[]},q=new he.default(f),s=ge.ref([]),p=new Map,b=new Map,k=new Map,C=[],d=G.computed(()=>{var e;return((e=f.rowConfig)==null?void 0:e.keyField)??"id"});G.onMounted(()=>{setTimeout(()=>{var t;let e=((t=f.sortConfig)==null?void 0:t.defaultSort)??[];e=Array.isArray(e)?e:[e],B(e)})});const O=(e,t=null,n=!1)=>{if(V.isObject(t)){const r=s.value.findIndex(o=>o[d.value]===t[d.value]),i=n?r+1:r;s.value.splice(i,0,...e);return}const{parentField:a}=E(),l=le(e,a);for(const{node:r,children:i}of l.values()){const o=s.value.findIndex(c=>c[d.value]===r[a]);if(o===-1){t===-1?s.value.push(r,...i):s.value.unshift(r,...i);continue}if(t===-1){let c=o+1;for(;s.value[c][a]===r[a];)c++;s.value.splice(c,0,r,...i)}else s.value.splice(o+1,0,r,...i)}},H=e=>new Promise(t=>{const n=Array.isArray(e)?e:[e];f.useTree?(F(),O(n),x()):s.value.unshift(...n),P(n,p),t(e)}),N=(e,t,n=!1)=>new Promise(a=>{const l=Array.isArray(e)?e:[e];if(f.useTree){F();const{parentField:r}=E();let i=-1;if(typeof t!="object"&&t!==void 0&&t!==-1)console.warn("Unable to insert into the specified position, please check if the parameters are correct"),i=-1;else if(t==null)i=null;else if(t===-1)i=-1;else if(!s.value.find(c=>c[d.value]===(t==null?void 0:t[d.value])))console.warn("Unable to insert into the specified position, please check if the parameters are correct"),i=-1;else{const c=t&&typeof t=="object"?t[r]??null:null;for(const v of l)c&&(v==null?void 0:v[r])!==c&&(console.error(`cannot support parentId=${v[r]}, maybe parentId=${c}`),v[r]=c);i=t}O(l,i,n),x()}else{let r;const i=s.value.length;typeof t=="number"?r=t===-1?t:(Number.isNaN(Math.floor(t))?0:Math.floor(t))%i:typeof t=="object"?(r=s.value.findIndex(o=>o[d.value]===(t==null?void 0:t[d.value])),r===-1&&console.warn("Unable to insert into the specified position, please check if the parameters are correct")):r=-1,r===-1?s.value.push(...l):(r=n?r+1:r,s.value.splice(r,0,...l))}P(l,p),a(e)}),J=(e,t)=>N(e,t),K=(e,t)=>N(e,t,!0),Q=()=>new Promise(e=>{F();const t=Array.from(p.values());for(let n=0;n<s.value.length-1&&p.size!==0;n++){const a=s.value[n][d.value];p.has(a)&&(s.value.splice(n,1),p.delete(a),n--)}x(),e({rows:t,row:t})}),W=()=>Array.from(p.values()),X=e=>p.has(e[d.value]),Y=e=>new Promise(t=>{var i;e===void 0&&(s.value.length=0,t({rows:[],row:null})),F();let n=e;Array.isArray(e)||(n=[e]);const a=new Map(n.filter(o=>V.isObject(o)).map(o=>[o[d.value],o])),l=[],{parentField:r}=E();for(let o=0;o<s.value.length;o++){const c=s.value[o][d.value];if(a.has(c)){const v=new Set;v.add(c);let g=o+1;const h=s.value.length;for(;h>g&&v.has((i=s.value[g])==null?void 0:i[r]);)v.add(s.value[g][d.value]),g++;l.push(...s.value.splice(o,g-o)),a.delete(c),o--}}x(),P(l,b),t({rows:e,row:e})}),Z=()=>Array.from(b.values()),$=()=>({insertRecords:Array.from(p.values()),removeRecords:Array.from(b.values()),updateRecords:Array.from(k.values()),pendingRecords:[]}),ee=(e,t)=>new Promise(n=>{(!e||!t)&&n(e);let a=e;Array.isArray(e)||(a=[e]),a.forEach(l=>{Object.assign(l,t),k.set(l[d.value],l)}),n(e)}),te=(e,t)=>B({field:e,order:t},!0),B=(e,t=!0)=>{var a;const n=(a=u.value)==null?void 0:a.setSort(e,!1);return t&&D(),n},ne=e=>{var n;const t=(n=u.value)==null?void 0:n.clearSort(e);return D(),t},re=(e,t,n=!1)=>new Promise(async a=>{var l;await((l=u.value)==null?void 0:l.setFilter(e,t)),n&&D(),a(!0)}),ae=e=>new Promise(async t=>{var n;await((n=u.value)==null?void 0:n.clearFilter(e)),D(),t(!0)}),D=()=>{var c,v,g;F();const e=[...A.data],t=(c=u.value)==null?void 0:c.getSortColumns(),{sortMethod:n,remote:a}=f.sortConfig??{};if(a!==!1&&(t==null?void 0:t.length)>0)if(t.forEach(h=>{const{dataType:y,sortBy:m,sortType:w}=f.column.find(T=>T.field===h.field)??{};h.sortBy=typeof m=="function"?m({column:h.column,row:null}).toString():m,h.sortType=w??(y==="number"?"number":"string")}),typeof n=="function"){const h=t!=null&&t.length?n({$table:u.value,data:[...A.data],sortList:t}):[...A.data];e.push(...h)}else L.multiFieldSort(e,t);const{remote:l,filterMethod:r,isEvery:i=!1}=f.filterConfig??{},o=U();if(l!==!1){q.initTableData([...A.data]),q.initTableMap();const h=[];for(const y of o){const{filters:m=[],field:w=""}=y,{dataType:T="string"}=f.column.find(R=>R.field===w)??{},S=((v=me.logicOptions.find(R=>R.type===T))==null?void 0:v.logicList)??[],_=m.filter(R=>!!R.checked);for(const R of _){const{label:M,value:j,logic:I="equal",ignoreCase:fe=!1}=R,de=((g=S.find(z=>z.logic===I))==null?void 0:g.handler)??((z,ve,pe=!1)=>z===ve);h.push({label:M,value:j,field:w,logic:I,ignoreCase:fe,_handler:de,column:y.column,filterItem:y})}}if(h.length>0){let y=e.filter(m=>h.some(w=>{const{field:T,value:S,_handler:_,ignoreCase:R=!1,column:M,filterItem:j}=w,I=M.filterMethod;return typeof I=="function"?I({$table:u.value,cellValue:m[T],row:m,value:S,column:M,option:j}):typeof r=="function"?r({$table:u.value,cellValue:m[T],row:m,value:S,column:M,options:o}):_(m[T],S,R)}));f.useTree&&(y=q.handleTreeData(y,i)),e.length=0,e.push(...y)}}s.value.length=0,s.value.push(...e),x()};function U(){var t;return(((t=u.value)==null?void 0:t.getCheckedFilters())??[]).map(n=>{const{field:a="",column:{filters:l=[]}}=n,{filters:r=[],dataType:i="string"}=f.column.find(c=>c.field===a)??{},o=l.map(c=>{const{logic:v="equal",ignoreCase:g=!1}=r.find(h=>h.value===c.value)??{};return{...c,logic:v,ignoreCase:g}});return{...n,filters:o,dataType:i}})}function le(e,t){var a;const n=new Map(e.map(l=>[l[d.value],{node:l,children:[]}]));for(const l of e)l[t]&&n.has(l[t])&&((a=n.get(l[t]))==null||a.children.push(l),n.delete(l[d.value]));return n}function P(e,t){e.forEach(n=>{t.set(n[d.value],n)})}function F(){const e=u.value;!e||!f.useTree||(C.length=0,C.push(...e.getTreeExpandRecords()??[]))}async function x(){const e=u.value;!e||!f.useTree||setTimeout(async()=>{await e.setTreeExpand(C,!0),C.length=0})}function se(){var i,o;if(f.useTree&&((i=f.treeConfig)!=null&&i.lazy))return;F();const{rowField:e,parentField:t}=E(),{fullData:n=[]}=((o=u.value)==null?void 0:o.getTableData())??{},l=(f.useTree?L.transformTreeData(n,{idField:e,parentField:t}):n).map(c=>c[e]),r=L.sortBySmallerList(s.value,l,e);s.value.length=0,s.value.push(...r),setTimeout(()=>{x()})}async function oe(e,t,n=100){return new Promise(async(a,l)=>{var o,c,v,g,h;u.value||l("table instance is not exist");const r=Array.isArray(e)?e:[e];if(!(((o=f.treeConfig)==null?void 0:o.lazy)??!1))await((c=u.value)==null?void 0:c.setTreeExpand(e,t)),a(null);else{try{const y=new Event("click",{bubbles:!0});for(const m of r){if(await((v=u.value)==null?void 0:v.clearTreeExpandLoaded(m)),((g=u.value)==null?void 0:g.isTreeExpandByRow(m))===t)continue;const T=(h=u.value)==null?void 0:h.$el.querySelector(`[rowid='${m.id}'] .vxe-tree--btn-wrapper`);T&&T.dispatchEvent(y)}}catch(y){console.error(y)}setTimeout(()=>{a(null)},n)}})}function ie(e){p.clear(),b.clear(),k.clear();const t=Array.isArray(e)?e:[];return s.value=Array.from(t),A.data=[...s.value],s.value}function ce(e){var r;if(!u.value)return console.error("table instance is not exist"),null;const t=(r=u.value)==null?void 0:r.getRowById(e);if(t)return t;const n=s.value.find(i=>i[d.value]===e);return n||(u.value.getInsertRecords().find(i=>i[d.value]===e)??null)}function E(){var n,a;const e=((n=f.treeConfig)==null?void 0:n.rowField)??"id",t=((a=f.treeConfig)==null?void 0:a.parentField)??"pid";return{rowField:e,parentField:t}}function ue(){const e=document.querySelector(".vxe-table--tooltip-wrapper");e&&(e==null||e.remove())}return{_methods:{insert:H,insertAt:J,insertNextAt:K,removeInsertRow:Q,getInsertRecords:W,isInsertByRow:X,remove:Y,getRemoveRecords:Z,getRecordset:$,setRow:ee,setTreeExpand:oe,getRowById:ce,sort:te,setSort:B,clearSort:ne,setFilter:re,clearFilter:ae,getCheckedFilters:U,disposeRowTooltip:ue},setTableData:ie,handleSortAndFilter:D,dragSort:se}}exports.useMethods=ye;
