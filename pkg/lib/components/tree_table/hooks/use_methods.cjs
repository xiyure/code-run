"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const L=require("vue"),G=require("../../../node_modules/@vue/shared/dist/shared.esm-bundler.cjs"),he=require("../model/tree_store.cjs"),O=require("../../../utils/utils.cjs");require("../../../node_modules/resize-observer-polyfill/dist/ResizeObserver.es.cjs");require("../../../node_modules/sortablejs/modular/sortable.esm.cjs");require("../../../node_modules/culori/src/index.cjs");const me=require("../../../constant/filter_data.cjs");function ge(f,u){const A={data:[]},k=new he.default(f),s=L.ref([]),p=new Map,b=new Map,q=new Map,E=[],d=L.computed(()=>{var e;return((e=f.rowConfig)==null?void 0:e.keyField)??"id"});L.onMounted(()=>{setTimeout(()=>{var t;let e=((t=f.sortConfig)==null?void 0:t.defaultSort)??[];e=Array.isArray(e)?e:[e],P(e)})});const N=(e,t=null,n=!1)=>{if(G.isObject(t)){const a=s.value.findIndex(o=>o[d.value]===t[d.value]),i=n?a+1:a;s.value.splice(i,0,...e);return}const{parentField:r}=C(),l=le(e,r);for(const{node:a,children:i}of l.values()){const o=s.value.findIndex(c=>c[d.value]===a[r]);if(o===-1){t===-1?s.value.push(a,...i):s.value.unshift(a,...i);continue}if(t===-1){let c=o+1;for(;s.value[c][r]===a[r];)c++;s.value.splice(c,0,a,...i)}else s.value.splice(o+1,0,a,...i)}},H=e=>new Promise(t=>{const n=Array.isArray(e)?e:[e];f.useTree?(F(),N(n),x()):s.value.unshift(...n),B(n,p),t(e)}),U=(e,t,n=!1)=>new Promise(r=>{const l=Array.isArray(e)?e:[e];if(f.useTree){F();const{parentField:a}=C();let i=-1;if(typeof t!="object"&&t!==void 0&&t!==-1)console.warn("Unable to insert into the specified position, please check if the parameters are correct"),i=-1;else if(t==null)i=null;else if(t===-1)i=-1;else if(!s.value.find(c=>c[d.value]===(t==null?void 0:t[d.value])))console.warn("Unable to insert into the specified position, please check if the parameters are correct"),i=-1;else{const c=t&&typeof t=="object"?t[a]??null:null;for(const v of l)c&&(v==null?void 0:v[a])!==c&&(console.error(`cannot support parentId=${v[a]}, maybe parentId=${c}`),v[a]=c);i=t}N(l,i,n),x()}else{let a;const i=s.value.length;typeof t=="number"?a=t===-1?t:(Number.isNaN(Math.floor(t))?0:Math.floor(t))%i:typeof t=="object"?(a=s.value.findIndex(o=>o[d.value]===(t==null?void 0:t[d.value])),a===-1&&console.warn("Unable to insert into the specified position, please check if the parameters are correct")):a=-1,a===-1?s.value.push(...l):(a=n?a+1:a,s.value.splice(a,0,...l))}B(l,p),r(e)}),J=(e,t)=>U(e,t),K=(e,t)=>U(e,t,!0),Q=()=>new Promise(e=>{F();const t=Array.from(p.values());for(let n=0;n<s.value.length-1&&p.size!==0;n++){const r=s.value[n][d.value];p.has(r)&&(s.value.splice(n,1),p.delete(r),n--)}x(),e({rows:t,row:t})}),W=()=>Array.from(p.values()),X=e=>p.has(e[d.value]),Y=e=>new Promise(t=>{var i;e===void 0&&(s.value.length=0,t({rows:[],row:null})),F();let n=e;Array.isArray(e)||(n=[e]);const r=new Map(n.filter(o=>G.isObject(o)).map(o=>[o[d.value],o])),l=[],{parentField:a}=C();for(let o=0;o<s.value.length;o++){const c=s.value[o][d.value];if(r.has(c)){const v=new Set;v.add(c);let g=o+1;const h=s.value.length;for(;h>g&&v.has((i=s.value[g])==null?void 0:i[a]);)v.add(s.value[g][d.value]),g++;l.push(...s.value.splice(o,g-o)),r.delete(c),o--}}x(),B(l,b),t({rows:e,row:e})}),Z=()=>Array.from(b.values()),$=()=>({insertRecords:Array.from(p.values()),removeRecords:Array.from(b.values()),updateRecords:Array.from(q.values()),pendingRecords:[]}),ee=(e,t)=>new Promise(n=>{(!e||!t)&&n(e);let r=e;Array.isArray(e)||(r=[e]),r.forEach(l=>{Object.assign(l,t),q.set(l[d.value],l)}),n(e)}),te=(e,t)=>P({field:e,order:t},!0),P=(e,t=!0)=>{var r;const n=(r=u.value)==null?void 0:r.setSort(e,!1);return t&&D(),n},ne=e=>{var n;const t=(n=u.value)==null?void 0:n.clearSort(e);return D(),t},ae=(e,t,n=!1)=>new Promise(async r=>{var l;await((l=u.value)==null?void 0:l.setFilter(e,t)),n&&D(),r(!0)}),re=e=>new Promise(async t=>{var n;await((n=u.value)==null?void 0:n.clearFilter(e)),D(),t(!0)}),D=()=>{var c,v,g;F();const e=[...A.data],t=(c=u.value)==null?void 0:c.getSortColumns(),{sortMethod:n,remote:r}=f.sortConfig??{};if(r!==!1&&(t==null?void 0:t.length)>0)if(t.forEach(h=>{const{dataType:y,sortBy:m,sortType:w}=f.column.find(T=>T.field===h.field)??{};h.sortBy=typeof m=="function"?m({column:h.column,row:null}).toString():m,h.sortType=w??(y==="number"?"number":"string")}),typeof n=="function"){const h=t!=null&&t.length?n({$table:u.value,data:[...A.data],sortList:t}):[...A.data];e.push(...h)}else O.multiFieldSort(e,t);const{remote:l,filterMethod:a,isEvery:i=!1}=f.filterConfig??{},o=V();if(l!==!1){k.initTableData([...A.data]),k.initTableMap();const h=[];for(const y of o){const{filters:m=[],field:w=""}=y,{dataType:T="string"}=f.column.find(R=>R.field===w)??{},S=((v=me.logicOptions.find(R=>R.type===T))==null?void 0:v.logicList)??[],_=m.filter(R=>!!R.checked);for(const R of _){const{label:M,value:j,logic:I="equal",ignoreCase:fe=!1}=R,de=((g=S.find(z=>z.logic===I))==null?void 0:g.handler)??((z,ve,ye=!1)=>z===ve);h.push({label:M,value:j,field:w,logic:I,ignoreCase:fe,_handler:de,column:y.column,filterItem:y})}}if(h.length>0){let y=e.filter(m=>h.some(w=>{const{field:T,value:S,_handler:_,ignoreCase:R=!1,column:M,filterItem:j}=w,I=M.filterMethod;return typeof I=="function"?I({$table:u.value,cellValue:m[T],row:m,value:S,column:M,option:j}):typeof a=="function"?a({$table:u.value,cellValue:m[T],row:m,value:S,column:M,options:o}):_(m[T],S,R)}));f.useTree&&(y=k.handleTreeData(y,i)),e.length=0,e.push(...y)}}s.value.length=0,s.value.push(...e),x()};function V(){var t;return(((t=u.value)==null?void 0:t.getCheckedFilters())??[]).map(n=>{const{field:r="",column:{filters:l=[]}}=n,{filters:a=[],dataType:i="string"}=f.column.find(c=>c.field===r)??{},o=l.map(c=>{const{logic:v="equal",ignoreCase:g=!1}=a.find(h=>h.value===c.value)??{};return{...c,logic:v,ignoreCase:g}});return{...n,filters:o,dataType:i}})}function le(e,t){var r;const n=new Map(e.map(l=>[l[d.value],{node:l,children:[]}]));for(const l of e)l[t]&&n.has(l[t])&&((r=n.get(l[t]))==null||r.children.push(l),n.delete(l[d.value]));return n}function B(e,t){e.forEach(n=>{t.set(n[d.value],n)})}function F(){const e=u.value;!e||!f.useTree||(E.length=0,E.push(...e.getTreeExpandRecords()??[]))}async function x(){const e=u.value;!e||!f.useTree||setTimeout(async()=>{await e.setTreeExpand(E,!0),E.length=0})}function se(){var i,o;if(f.useTree&&((i=f.treeConfig)!=null&&i.lazy))return;F();const{rowField:e,parentField:t}=C(),{fullData:n=[]}=((o=u.value)==null?void 0:o.getTableData())??{},l=(f.useTree?O.transformTreeData(n,{idField:e,parentField:t}):n).map(c=>c[e]),a=O.sortBySmallerList(s.value,l,e);s.value.length=0,s.value.push(...a),setTimeout(()=>{x()})}async function oe(e,t,n=100){return new Promise(async(r,l)=>{var o,c,v,g,h;u.value||l("table instance is not exist");const a=Array.isArray(e)?e:[e];if(!(((o=f.treeConfig)==null?void 0:o.lazy)??!1))await((c=u.value)==null?void 0:c.setTreeExpand(e,t)),r(null);else{try{const y=new Event("click",{bubbles:!0});for(const m of a){if(await((v=u.value)==null?void 0:v.clearTreeExpandLoaded(m)),((g=u.value)==null?void 0:g.isTreeExpandByRow(m))===t)continue;const T=(h=u.value)==null?void 0:h.$el.querySelector(`[rowid='${m.id}'] .vxe-tree--btn-wrapper`);T&&T.dispatchEvent(y)}}catch(y){console.error(y)}setTimeout(()=>{r(null)},n)}})}function ie(e){p.clear(),b.clear(),q.clear();const t=Array.isArray(e)?e:[];return s.value=Array.from(t),A.data=[...s.value],s.value}function ce(e){var a;if(!u.value)return console.error("table instance is not exist"),null;const t=(a=u.value)==null?void 0:a.getRowById(e);if(t)return t;const n=s.value.find(i=>i[d.value]===e);return n||(u.value.getInsertRecords().find(i=>i[d.value]===e)??null)}function C(){var n,r;const e=((n=f.treeConfig)==null?void 0:n.rowField)??"id",t=((r=f.treeConfig)==null?void 0:r.parentField)??"pid";return{rowField:e,parentField:t}}function ue(){const e=document.querySelector(".vxe-table--tooltip-wrapper");e&&(e==null||e.remove())}return{_methods:{insert:H,insertAt:J,insertNextAt:K,removeInsertRow:Q,getInsertRecords:W,isInsertByRow:X,remove:Y,getRemoveRecords:Z,getRecordset:$,setRow:ee,setTreeExpand:oe,getRowById:ce,sort:te,setSort:P,clearSort:ne,setFilter:ae,clearFilter:re,getCheckedFilters:V,disposeRowTooltip:ue},setTableData:ie,handleSortAndFilter:D,dragSort:se}}exports.useMethods=ge;
