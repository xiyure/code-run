"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),Ge=require("./column_group.cjs"),Je=require("../operate/index.cjs"),We=require("../table/index.cjs"),Xe=require("../pagination/index.cjs"),et=require("./table_header.vue.cjs"),tt=require("./table_card.vue.cjs"),rt=require("./hooks/use_methods.cjs"),nt=require("./hooks/use_checkbox.cjs"),ot=require("./hooks/use_data.cjs"),at=require("./hooks/use_config.cjs"),lt=require("./hooks/use_header_control.cjs"),it=require("./hooks/use_advanced_filter.cjs"),st=require("../../hooks/use_size.cjs"),ut=require("../../hooks/use_locale.cjs"),W=require("../../hooks/use_deprecated.cjs"),ct=require("../../hooks/use_inherit_slot.cjs"),ft=require("../../utils/utils.cjs");require("../../node_modules/resize-observer-polyfill/dist/ResizeObserver.es.cjs");require("../../node_modules/sortablejs/modular/sortable.esm.cjs");require("../../node_modules/culori/src/index.cjs");const dt=require("./const.cjs"),gt=require("../../node_modules/lodash-es/cloneDeep.cjs"),ht={key:0,ref:"RefTableBox",class:"table-box flex-1 overflow-hidden"},pt={key:0,class:"batch-operate"},vt={key:2,ref:"RefTablePagination",class:"pagination-box"},mt=e.defineComponent({name:"KTreeTable",__name:"tree_table",props:{data:{},size:{},sortConfig:{},filterConfig:{},seqConfig:{},rowConfig:{},editConfig:{},scrollY:{},columnConfig:{},checkboxConfig:{},treeConfig:{},showOverflow:{type:[String,Boolean],default:!0},autoResize:{type:Boolean,default:!0},height:{default:"100%"},align:{},border:{type:[Boolean,String],default:"default"},emptyText:{},rowStyle:{},column:{},showPage:{type:Boolean,default:!0},useTree:{type:Boolean},isRemoteQuery:{type:Boolean},isServerPaging:{type:Boolean},paginationConfig:{},showDescription:{type:Boolean,default:!0},showHeaderTools:{type:Boolean,default:!0},batchOperations:{},showBatchOperation:{type:Boolean},batchOperateConfig:{},showColumnMenu:{type:Boolean,default:!1},showDragColumn:{type:Boolean},cellClickToggleHighlight:{type:Boolean,default:!0},widgets:{},showSearchInput:{type:Boolean,default:!0},showFilter:{type:Boolean,default:!0},showRefresh:{type:Boolean,default:!0},showTransfer:{type:Boolean,default:!1},showSizeControl:{type:Boolean},advancedFilterConfig:{},searchConfig:{},style:{},class:{},simple:{type:Boolean},defaultTransferData:{},onTransferShow:{},onTransferHide:{},onTransferChange:{},onAdvancedFilterShow:{},onAdvancedFilterHide:{},useAntStyle:{type:Boolean},round:{type:Boolean,default:!1},adaptive:{type:Boolean},hasSpace:{type:Boolean,default:!1},requestMethod:{},cardOptions:{},defaultMode:{default:"list"},transferConfig:{}},emits:["remote-query","server-paging","refresh","highlight-clear","highlight-change","cell-click","resizable-change","hide-column","checkbox-change","checkbox-all","row-dragend","sort-change","filter-change","clear-filter","advanced-filter-confirm","advanced-filter-clear","page-current-change","page-size-change","page-change","prev-click","next-click"],setup(X,{expose:ee,emit:te}){const o=X;W.useDeprecated({scope:"k-tree-table",from:"isRemoteQuery",replacement:"searchConfig.isRemoteQuery",version:"2.0.0"},e.computed(()=>!!o.isRemoteQuery)),W.useDeprecated({scope:"k-tree-table",from:"isServerPaging",replacement:"paginationConfig.isRemotePaging",version:"2.0.0"},e.computed(()=>!!o.isServerPaging));const{t:C}=ut.useLocale(),re=ct.useInheritSlot(["default"]),s=te,_=e.ref(),h=e.ref(o.size),T=e.ref(o.defaultMode==="card"?"card":"list"),p=e.ref(),w=e.ref([]),d=e.ref([]),y=e.ref(""),ne=e.computed(()=>{var a,i,n;const t=!!((i=(a=b.value)==null?void 0:a.conditionList)!=null&&i.length),r=((n=o.advancedFilterConfig)==null?void 0:n.remote)===!0;return t&&!r?v.value:d.value}),c=e.computed(()=>_.value),oe=e.computed(()=>h.value??void 0),x=e.computed(()=>{const t=V.value.map(r=>r.id);return!!(o.showHeaderTools&&t.includes("transfer"))}),ae=e.computed(()=>{const{placeholder:t=C==null?void 0:C("table.searchTable")}=o.searchConfig??{};return{placeholder:t}}),le=e.computed(()=>{const{remote:t,ignoreCase:r,dateFormat:a,timeFormat:i,defaultCondition:n}=o.advancedFilterConfig??{};return{conditionInfo:b.value,data:d.value,columns:we.value,text:ye.value,remote:t,ignoreCase:r,dateFormat:a,timeFormat:i,defaultCondition:n}}),ie=e.computed(()=>{const{drag:t=!0,showSearch:r=!0}=o.transferConfig??{};return{drag:t,showSearch:r,selectData:E.value,originData:fe.value,defaultHeader:de.value}}),H=e.computed(()=>T.value==="list"),{setTableData:se,handleSortAndFilter:A,dragSort:ue,_methods:ce}=rt.useMethods(o,c),{flatColumns:B,selectData:E,originData:fe,defaultHeader:de,updateTransfer:ge,transferChange:M,transferHide:he,transferShow:pe,sortTableHeader:ve,updateColVisible:me,_transferMethods:Ce}=lt.useHeaderControl(c,p,o,w),{newFilterData:v,filterColumns:we,filterConditionInfo:b,headerText:ye,advancedFilterShow:be,advancedFilterHide:Se,getAdvancedCondition:ke}=it.useAdvancedFilter(p,o,w),{showTableData:f,isPaging:F,dataLength:O,paginationConfig:L,treeStore:I,changePageSize:Te,changeCurrentPage:Be,handleRemoteData:N}=ot.useData(c,o,s,B,d,ne,y,b,P),{widgets:V,treeConfig:K,sortConfig:Fe,rowConfig:Q,editConfig:De,scrollY:Re,columnConfig:qe,seqConfig:ze}=at.useConfig(o,{isPaging:F,paginationConfig:L}),{checkboxConfig:Pe,batchOpConfig:$,closeBatchOperation:_e,checkBoxChange:xe,checkboxAllChange:He,initCheckedData:Ae,clearCheckedData:D,resetCheckboxStatus:g,_checkboxMethods:Ee}=nt.useCheckbox(c,o,d,f,I);e.onBeforeMount(()=>{G()}),e.watch([()=>o.data,()=>{var t;return(t=o.data)==null?void 0:t.length}],()=>{D(),P(o.data??[]),q(),Ae()},{immediate:!0}),e.watch(()=>o.column,()=>{w.value=o.column.map(t=>{const r=t.visible!==!1,a=t.field??`_table_column_${t.type??""}`,i=t.editRender??(typeof t.renderEdit=="function"?{}:void 0);return{...gt.default(t),visible:r,field:a,editRender:i}}),ge()},{deep:!0});let S=!1;e.watch(()=>{var t;return(t=f.value)==null?void 0:t.length},()=>{var t;!o.useTree||(t=K.value)!=null&&t.lazy||!H.value||e.nextTick(()=>{var r,a;if(y.value.trim()||S){S=!1;const i=f.value.length>500?500:f.value.length,n=f.value.slice(0,i);(r=c.value)==null||r.setTreeExpand(n,!0)}else(a=c.value)==null||a.clearTreeExpand()})},{immediate:!0});function Me(t){if(!o.rowStyle){const{row:r}=t;return r.style||{}}return typeof o.rowStyle=="function"?o.rowStyle(t):o.rowStyle}function Oe(t){if(!x.value)return;const r=B.value.find(a=>a.field===t.field);r&&(r.visible=!1,E.value=B.value.filter(a=>a.visible!==!1).map(a=>a.title&&a.field?a.field:null).filter(a=>a!==null),s("hide-column",t))}async function R(t,r=[],a=!0){var n;b.value=t;const{remote:i}=o.advancedFilterConfig??{};if(i===!0){a&&s("advanced-filter-confirm",{conditionInfo:t,tableData:[]}),await N(),v.value=d.value;return}if(g(),v.value=r,o.useTree){const{isEvery:l=!1}=o.advancedFilterConfig??{};v.value=I.handleTreeData(v.value,l)}(n=t==null?void 0:t.conditionList)!=null&&n.length?S=!0:S=!1,a&&s("advanced-filter-confirm",{conditionInfo:t,tableData:[]})}function Le(){z(),s("advanced-filter-clear")}let m=!1,k=null;function Ie({row:t,rowid:r}){var n,l,u;if(!o.cellClickToggleHighlight)return;m?m&&k===r&&((n=c.value)==null||n.setCurrentRow(null),m=!1,k=null,s("highlight-clear",t)):m=!0;const a=(l=c.value)==null?void 0:l.getCurrentRecord(),i=(u=c.value)==null?void 0:u.getRowid(a);k!==r&&i===r&&(k=r),s("highlight-change",t,m)}async function q(t){var l;const r=Y();if(!r)return;await e.nextTick();const a=(l=r==null?void 0:r.filter)==null?void 0:l.call(r,t),{conditionInfo:i,data:n}=a??{};return await R(i,n,!1),{conditionInfo:i,tableData:n}}async function z(){var n;const t=Y();if(!t)return;await e.nextTick(),g();const r=(n=t==null?void 0:t.clearFilter)==null?void 0:n.call(t),{conditionInfo:a,data:i}=r??{};return await R(a,i,!1),{conditionInfo:a,tableData:i}}function Y(){var t,r;return(r=(t=p.value)==null?void 0:t.filterRef)==null?void 0:r[0]}function j(t){y.value=t??"",g()}function U(){var t,r;(r=(t=p.value)==null?void 0:t.clearInput)==null||r.call(t),y.value=""}function Ne(t){A(),s("sort-change",t)}function Z(t){A(),s("filter-change",t)}function Ve(t){ue(),s("row-dragend",t)}async function Ke(t){await e.nextTick(),t==="list"&&g()}function Qe(){return f.value}function $e(){return d.value}function Ye(t){Array.isArray(t)&&(P(t),q(t))}function P(t){d.value=se(t)}async function G(t=!1){var n,l,u;const r=((n=o.searchConfig)==null?void 0:n.isRemoteQuery)||o.isRemoteQuery,a=((l=o.advancedFilterConfig)==null?void 0:l.remote)===!0;(F.value&&(o.isServerPaging||((u=o.paginationConfig)==null?void 0:u.isRemotePaging))||r||a)&&(t&&(D(),g()),N())}function je(){D(),z(),U()}e.provide("__showTransfer",x),e.provide(st.SIZE_KEY,e.computed(()=>h.value==="small"||h.value==="mini"?"sm":"base")),e.provide(dt.TABLE_SIZE_KEY,h),e.provide("__hasSpace__",e.computed(()=>o.hasSpace));const Ue={tableInstance:c,filter:j,advancedFilter:q,clearAdvancedFilter:z,getAdvancedCondition:ke,getVisibleData:Qe,getFullData:$e,loadData:Ye,clearSearch:U,clearTableStatus:je,refreshTableData:G,...ce,...Ee,...Ce};return ee(ft.getExposeProxy(Ue,c)),(t,r)=>{var i;const a=e.resolveDirective("ksw_drag");return e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(["k-tree-table flex h-full flex-col",o.class,{"tree-table-use-ant-style":t.useAntStyle,"has-space-between":t.hasSpace}]),style:e.normalizeStyle({height:t.adaptive?"fit-content":t.height,...t.style})},[e.createVNode(et.default,{ref_key:"headerRef",ref:p,"current-mode":T.value,"onUpdate:currentMode":r[0]||(r[0]=n=>T.value=n),simple:t.simple,"show-search-input":t.showSearchInput,"show-description":t.showDescription,"show-header-tools":t.showHeaderTools,widgets:e.unref(V),"data-length":e.unref(O),"show-total":!t.useTree,"search-config":ae.value,"filter-config":le.value,"transfer-config":ie.value,onInputChange:j,onFilterConfirm:R,onFilterClear:Le,onFilterShow:e.unref(be),onFilterHide:e.unref(Se),onTransferChange:e.unref(me),onTransferShow:e.unref(pe),onTransferHide:r[1]||(r[1]=()=>{e.unref(he)(),e.unref(M)()}),onSizeChange:r[2]||(r[2]=n=>{h.value=n||void 0}),onTransferDrag:e.unref(ve),onRefresh:r[3]||(r[3]=()=>{s("refresh")}),onSwitchChange:Ke},e.createSlots({_:2},[e.renderList(t.$slots,(n,l)=>({name:l,fn:e.withCtx(u=>[e.renderSlot(t.$slots,l,e.normalizeProps(e.guardReactiveProps(u)))])}))]),1032,["current-mode","simple","show-search-input","show-description","show-header-tools","widgets","data-length","show-total","search-config","filter-config","transfer-config","onFilterShow","onFilterHide","onTransferChange","onTransferShow","onTransferDrag"]),H.value?(e.openBlock(),e.createElementBlock("div",ht,[e.createVNode(e.unref(We.KTable),e.mergeProps({ref_key:"xTree",ref:_,border:t.useAntStyle?"inner":t.border,size:oe.value,data:e.unref(f),"row-config":e.unref(Q),"sort-config":e.unref(Fe),"filter-config":t.filterConfig,"tree-config":e.unref(K),"seq-config":e.unref(ze),"checkbox-config":e.unref(Pe),"edit-config":e.unref(De),"column-config":e.unref(qe),"empty-text":t.emptyText||((i=e.unref(C))==null?void 0:i("table.noData")),"scroll-y":e.unref(Re),"row-style":Me,"show-overflow":t.showOverflow,"auto-resize":t.autoResize,"show-column-menu":t.showColumnMenu,align:t.align,round:t.useAntStyle||t.round,height:t.adaptive?void 0:"100%"},t.$attrs,{onCheckboxChange:r[4]||(r[4]=n=>{e.unref(xe)(n),s("checkbox-change",n)}),onCheckboxAll:r[5]||(r[5]=n=>{e.unref(He)(n),s("checkbox-all",n)}),onHideColumn:Oe,onCellClick:r[6]||(r[6]=n=>{Ie(n),s("cell-click",n)}),onResizableChange:r[7]||(r[7]=n=>{e.unref(M)(),s("resizable-change",n)}),onSortChange:Ne,onFilterChange:Z,onClearFilter:r[8]||(r[8]=n=>{Z(n),s("clear-filter",n)}),onRowDragend:Ve}),e.createSlots({default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(w.value,(n,l)=>(e.openBlock(),e.createBlock(e.unref(Ge.default),{key:l,column:n,size:t.size,align:t.align},e.createSlots({_:2},[e.renderList(t.$slots,(u,J)=>({name:J,fn:e.withCtx(Ze=>[e.renderSlot(t.$slots,J,e.normalizeProps(e.guardReactiveProps(Ze)))])}))]),1032,["column","size","align"]))),128))]),_:2},[e.renderList(e.unref(re)(t.$slots),(n,l)=>({name:l,fn:e.withCtx(u=>[e.renderSlot(t.$slots,l,e.normalizeProps(e.guardReactiveProps(u)))])}))]),1040,["border","size","data","row-config","sort-config","filter-config","tree-config","seq-config","checkbox-config","edit-config","column-config","empty-text","scroll-y","show-overflow","auto-resize","show-column-menu","align","round","height"]),(t.batchOperateConfig||t.showBatchOperation)&&e.unref($).total>0?e.withDirectives((e.openBlock(),e.createElementBlock("div",pt,[e.createVNode(e.unref(Je.KOperate),e.mergeProps(e.unref($),{onClose:e.unref(_e)}),null,16,["onClose"])])),[[a]]):e.createCommentVNode("",!0)],512)):(e.openBlock(),e.createBlock(tt.default,{key:1,data:e.unref(f),"key-field":e.unref(Q).keyField,"card-attrs":t.cardOptions},e.createSlots({_:2},[e.renderList(t.$slots,(n,l)=>({name:l,fn:e.withCtx(u=>[e.renderSlot(t.$slots,l,e.normalizeProps(e.guardReactiveProps(u)))])}))]),1032,["data","key-field","card-attrs"])),e.unref(F)?(e.openBlock(),e.createElementBlock("div",vt,[e.createVNode(e.unref(Xe.KPagination),e.mergeProps(e.unref(L),{total:e.unref(O),onCurrentChange:e.unref(Be),onSizeChange:e.unref(Te),onChange:r[9]||(r[9]=(n,l)=>{e.unref(g)(),s("page-change",n,l)}),onPrevClick:r[10]||(r[10]=n=>{s("prev-click",n)}),onNextClick:r[11]||(r[11]=n=>{s("next-click",n)})}),null,16,["total","onCurrentChange","onSizeChange"])],512)):e.createCommentVNode("",!0)],6)}}});exports.default=mt;
