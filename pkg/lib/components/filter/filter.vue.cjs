"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});require("../../node_modules/vue/dist/vue.runtime.esm-bundler.cjs");const te=require("../../node_modules/dayjs/dayjs.min.cjs"),Ce=require("../input/index.cjs"),_e=require("../tree_select/index.cjs"),C=require("../select/index.cjs"),Be=require("../cascader/index.cjs"),ne=require("../button/index.cjs"),De=require("../date_picker/index.cjs"),z=require("../../constant/filter_data.cjs"),N=require("../../utils/utils.cjs");require("../../node_modules/resize-observer-polyfill/dist/ResizeObserver.es.cjs");require("../../node_modules/sortablejs/modular/sortable.esm.cjs");require("../../node_modules/culori/src/index.cjs");const ze=require("../../hooks/use_size.cjs"),Se=require("../../hooks/use_locale.cjs"),Te=require("../../node_modules/lodash-es/cloneDeep.cjs"),Ae=require("../../node_modules/ksw-vue-icon/es/icons/base/clearDate.cjs"),qe=require("../../node_modules/ksw-vue-icon/es/icons/base/add.cjs"),Fe=require("../../node_modules/ksw-vue-icon/es/icons/base/close.cjs"),oe=require("../../node_modules/ksw-vue-icon/es/icons/base/filter-fill.cjs"),re=require("../../node_modules/ksw-vue-icon/es/icons/base/filter.cjs"),Le=require("../../node_modules/element-plus/es/components/time-picker/index.cjs"),l=require("../../node_modules/@vue/runtime-core/dist/runtime-core.esm-bundler.cjs"),r=require("../../node_modules/@vue/reactivity/dist/reactivity.esm-bundler.cjs"),V=require("../../node_modules/@vue/runtime-core/node_modules/@vue/shared/dist/shared.esm-bundler.cjs"),Ne={key:1},Ee={class:"k-filter__content"},Ke={class:"k-filter__header"},xe=["title"],Re={class:"k-filter__condition"},Ue={class:"k-filter__logic"},Me=["title"],Oe={key:0,class:"k-filter__date-box"},$e=["onClick"],je={class:"k-filer__operate-left"},He={class:"k-filer__operate-right"},Pe={class:"select-label"},Ye=l.defineComponent({name:"KFilter",__name:"filter",props:{data:{default:()=>[]},options:{},border:{type:Boolean,default:!0},size:{},childrenField:{default:"children"},filterKey:{default:"title"},defaultCondition:{},remote:{type:[Boolean,Array]},dateFormat:{},timeFormat:{},ignoreCase:{type:Boolean,default:!1},maxNumber:{},simpleDateDisplay:{type:Boolean,default:!0}},emits:["confirm","clear","show","hide"],setup(ue,{expose:se,emit:ie}){const d=ue,y=ze.useSize(d),E=r.ref(""),S=ie,{t:b}=Se.useLocale(),h=r.ref([]),B=r.ref(0),T=l.computed(()=>N.treeDataToArray(Te.default(d.options),"group")),c=l.computed(()=>function(e){var n;return(n=T.value)==null?void 0:n.find(o=>o[d.filterKey]===e)}),M=l.computed(()=>function(e){var f;const a=(f=T.value)==null?void 0:f.find(p=>p[d.filterKey]===e.key),{dataType:n="string",logics:o}=a??{},{logicList:u=[]}=z.logicOptions.find(p=>p.type===n)??{},s=u.map(p=>p.logic);if(!o)return s;const g=Array.isArray(o)?o:[o],t=new Set(s);return g.filter(p=>t.has(p))}),ce=l.computed(()=>function(e){if(e.logic==="equal")return z.dateTypeOptions;const a=["past-seven-days","past-thirty-days"];return z.dateTypeOptions.filter(n=>!a.includes(n.value))}),K=l.computed(()=>h.value.some(e=>e.key&&e.logic&&(e.value||["empty","nonEmpty"].includes(e.logic)))),D=l.computed(()=>function(e){const a=["empty","nonEmpty"];return!e.logic||a.includes(e.logic)}),de=l.computed(()=>function(e){const a=["date","range"];return D.value(e)||!a.includes(e.dateRange)}),O=l.computed(()=>{const e=h.value.map(a=>a.key);return Array.isArray(d.remote)&&d.remote.some(a=>e.includes(a))});l.watch(()=>O.value,e=>{e&&(B.value=1)},{immediate:!0}),fe();function fe(){var a,n,o;B.value=((a=d.defaultCondition)==null?void 0:a.filterRule)??0;const{conditionList:e=[]}=d.defaultCondition??{};if(!Array.isArray(e)||!e.length){A();return}for(let u=0;u<e.length;u++)A();for(let u=0;u<h.value.length;u++){const s=h.value[u],{title:g,logic:t,value:f,showValue:p,key:_,handler:k}=e[u];s.title=g.split("-"),s.logic=t,s.value=f,s.showValue=p,s.key=_,s.handler=k;const m=(n=T.value)==null?void 0:n.find(L=>L[d.filterKey]===_);s._allowSelectLogic=!((o=m.options)!=null&&o.length),m.dataType==="date"&&!Array.isArray(f)?(s.dateRange="date",s.dateType="datetime"):m.dataType==="date"&&Array.isArray(f)&&(s.dateRange="range",s.dateType="datetimerange")}}function A(){const e={title:[],logic:"",showValue:"",value:"",key:"",handler:null,dateRange:"date",dateType:"datetime"};h.value.push(e)}function pe(e){e===0&&h.value.length===1?x(!1):h.value.splice(e,1)}function x(e=!0){return h.value.length=0,A(),e?R():{}}function ye(){const{conditionInfo:e,data:a}=R();S("confirm",e,a??[])}function R(e){const a=Array.isArray(e)?e:d.data,n=j();if(d.remote===!0||n.conditionList.length===0)return{conditionInfo:n,data:a};const o=a==null?void 0:a.filter(u=>B.value===0?n.conditionList.some(s=>$(s,u)):n.conditionList.every(s=>$(s,u)));return{conditionInfo:n,data:o??[]}}function $(e,a){var s,g,t;if(ve().has(e.key))return!0;const o=(s=T.value)==null?void 0:s.find(f=>f[d.filterKey]===e.key);if(!o||!o[d.filterKey])return!1;const u=a[o[d.filterKey]];return Array.isArray(e.value)?c.value(e.key).dataType==="date"||c.value(e.key).dataType==="time"?(t=e.handler)==null?void 0:t.call(e,u,e.value):e.value.some(f=>{var p;return(p=e.handler)==null?void 0:p.call(e,u,f,d.ignoreCase)}):(g=e.handler)==null?void 0:g.call(e,u,e.value,d.ignoreCase)}function j(){const e=["empty","nonEmpty"];return{conditionList:h.value.filter(n=>n.key&&n.logic&&(N.isValid(n.value)||e.includes(n.logic))).map(n=>{var o;return{title:n.title.join(" - "),logic:n.logic,key:n.key,showValue:n.showValue,value:n.value,handler:n.handler,config:((o=d.options)==null?void 0:o.find(u=>u[d.filterKey]===n.key))??[]}}),filterRule:B.value}}function ve(){return Array.isArray(d.remote)?new Map(d.remote.map((e,a)=>[e,a])):new Map}function ge(e){var p,_;const a=h.value[e];(p=c.value(a.key))!=null&&p.multiple&&(a.value=[]);const n=a.title??[];if(n.length===0){a.key=null,a.logic="equal",a.value="",a.showValue="";return}let o=d.options??[],u;for(const k of n)u=o==null?void 0:o.find(m=>m.title===k),o=(u==null?void 0:u.group)??[];a.key=u==null?void 0:u[d.filterKey];const s=(_=c.value(a.key))==null?void 0:_.dataType,g=s===void 0||s==="string"?"contain":"equal",t=M.value(a);a.logic=t.includes(g)?g:t[0],d.simpleDateDisplay&&(a.dateType="datetimerange");const f=z.logicOptions.find(k=>k.type===((u==null?void 0:u.dataType)||"string"));if(f){const k=f.logicList.find(m=>m.logic===a.logic);a.handler=(k==null?void 0:k.handler)??null}ke(a),a._allowSelectLogic=!0}function ke(e){const{dataType:a,valueFormat:n=d.timeFormat}=c.value(e.key)??{};if(a!=="time"){e.value="",e.showValue="";return}const o=new Date,u=N.formatterDate([new Date(o.getFullYear(),o.getMonth(),o.getDate()),o],n);e.value=u,e.showValue=u.join(" - ")}function he(e){var u;(e.logic==="after"||e.logic==="before")&&e.dateType==="datetimerange"&&(e.dateType="datetime",e.dateRange="date");const a=((u=c.value(e.key))==null?void 0:u.dataType)??"string",n=z.logicOptions.find(s=>s.type===a);if(!n)return;D.value(e)&&(e.value="",e.showValue="");const o=n.logicList.find(s=>s.logic===e.logic);e.handler=(o==null?void 0:o.handler)??null,a==="date"&&me(e)}function me(e){if(D.value(e)){e.value="",e.showValue="";return}H(e)}function H(e){var u;Ve(e);let a=Array.isArray(e.value)?"":e.value;switch(e.dateRange){case"range":a=["",""];break;case"today":a=v(0);break;case"tomorrow":a=v(1);break;case"yesterday":a=v(-1);break;case"current-week":a=[v(-q()+1),v(7-q(),!0)];break;case"last-week":a=[v(-q()-6),v(-q(),!0)];break;case"current-month":a=[v(-F()+1),v(P()-F(),!0)];break;case"last-month":a=[v(-F()-P(!0)+1),v(-F(),!0)];break;case"past-seven-days":a=[v(-7),v(-1,!0)];break;case"past-thirty-days":a=[v(-30),v(-1,!0)];break}const n=["current-week","last-week","current-month","last-month"],o=((u=c.value(e.key))==null?void 0:u.valueFormat)??d.dateFormat;e.dateType==="datetime"&&n.includes(e.dateRange)?e.showValue=e.value=W(a,o):(e.value=W(a,o),e.showValue=Array.isArray(e.value)?e.value.join(" - "):e.value)}function v(e,a=!1){const n=new Date,o=new Date(n);return o.setDate(o.getDate()+e),a?o.setHours(23,59,59,0):o.setHours(0,0,0,0),o}function q(){return new Date().getDay()}function F(){return new Date().getDate()}function P(e=!1){const a=new Date().getMonth()+1,n=e?a-1:a,o=[1,3,5,7,8,10,12],u=[4,6,9,11];if(o.includes(n))return 31;if(u.includes(n))return 30;const s=new Date().getFullYear();return s%4===0&&s%100!==0||s%400===0?29:28}function Ve(e){if(e.logic==="equal"){const a=["date","today","tomorrow","yesterday"];e.dateType=a.includes(e.dateRange)?"datetime":"datetimerange"}else if(e.logic==="after"||e.logic==="before"){const a=["range"];e.dateType=a.includes(e.dateRange)?"datetimerange":"datetime"}}function U(e,a,n){if(a==="input")e.showValue=e.value;else if(a==="select"){const o=Array.isArray(e.value)?e.value:[e.value],u=new Set(o);e.showValue=(n??[]).filter(s=>u.has(s.value)).map(s=>s.label).join(", ")}else if(a==="tree-select"){if(!Array.isArray(n)||!Array.isArray(e.value))return;e.showValue=N.getDataByTree(n,e.value,"value","children").map(o=>o.label).join(", ")}}function Y(e,a){a.showValue=Array.isArray(e)?e.join(" - "):e}function W(e,a){return a?Array.isArray(e)?e.map(n=>te.default(n).format(a)):te.default(e).format(a):e}function be(){S("show")}function we(){S("hide")}return se({filter:R,clearFilter:x,getConditionInfo:j}),(e,a)=>{const n=l.resolveComponent("k-popover");return l.openBlock(),l.createElementBlock("div",{class:V.normalizeClass(["k-filter",{"text-sm":r.unref(y).ownSize==="sm","text-base":r.unref(y).ownSize!=="sm"}])},[l.createVNode(n,{trigger:"click",width:"auto",teleported:!1,placement:"bottom-end","popper-class":E.value,onBeforeEnter:a[3]||(a[3]=()=>E.value="k-filter-popper__enter"),onBeforeLeave:a[4]||(a[4]=()=>E.value="k-filter-popper__leave"),onShow:be,onHide:we},{reference:l.withCtx(()=>[l.renderSlot(e.$slots,"reference",{hasConfigCondition:K.value},()=>[e.border?(l.openBlock(),l.createBlock(r.unref(ne.KButton),{key:0,size:r.unref(y).ownSize},{default:l.withCtx(()=>[K.value?(l.openBlock(),l.createBlock(r.unref(oe.default),{key:1,color:"#2882FF"})):(l.openBlock(),l.createBlock(r.unref(re.default),{key:0}))]),_:1},8,["size"])):(l.openBlock(),l.createElementBlock("span",Ne,[K.value?(l.openBlock(),l.createBlock(r.unref(oe.default),{key:1,color:"#2882FF"})):(l.openBlock(),l.createBlock(r.unref(re.default),{key:0}))]))])]),default:l.withCtx(()=>{var o,u,s,g;return[l.createElementVNode("div",Ee,[l.createElementVNode("div",Ke,[l.createElementVNode("span",{class:V.normalizeClass([r.unref(y).ownSize==="sm"?"text-base":"text-lg","font-bold"])},V.toDisplayString((o=r.unref(b))==null?void 0:o("filter.advancedFilter")),3),l.createElementVNode("span",{class:V.normalizeClass(r.unref(y).ownSize==="sm"?"text-sm":"text-base"),onClick:a[0]||(a[0]=()=>{x(),S("clear")})},[l.createVNode(r.unref(Ae.default)),l.createTextVNode(" "+V.toDisplayString((u=r.unref(b))==null?void 0:u("filter.clearAll")),1)],2)]),(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList(h.value,(t,f)=>{var p,_,k,m,L,G,J,Q,X,Z,I,ee,le,ae;return l.openBlock(),l.createElementBlock("div",{key:f,title:(p=t.title)==null?void 0:p.join("/"),class:"k-filter__item"},[l.createElementVNode("div",Re,[l.createVNode(r.unref(Be.KCascader),{modelValue:t.title,"onUpdate:modelValue":i=>t.title=i,teleported:!1,size:r.unref(y).ownSize,options:e.options,props:{label:"title",value:"title",children:d.childrenField},clearable:"",onChange:i=>ge(f)},null,8,["modelValue","onUpdate:modelValue","size","options","props","onChange"])]),l.createElementVNode("div",Ue,[!(((_=c.value(t.key))==null?void 0:_.dataType)==="date"&&e.simpleDateDisplay)&&!((k=c.value(t.key))!=null&&k.multiple)&&((m=c.value(t.key))==null?void 0:m.dataType)!=="time"?(l.openBlock(),l.createBlock(r.unref(C.KSelect),{key:0,modelValue:t.logic,"onUpdate:modelValue":i=>t.logic=i,size:r.unref(y).ownSize,teleported:!1,clearable:"",disabled:t._allowSelectLogic===!1,onChange:i=>he(t)},{default:l.withCtx(()=>[(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList(M.value(t),i=>{var w;return l.openBlock(),l.createBlock(r.unref(C.KOption),{key:i,label:(w=r.unref(b))==null?void 0:w(`filter.${i}`),value:i},null,8,["label","value"])}),128))]),_:2},1032,["modelValue","onUpdate:modelValue","size","disabled","onChange"])):l.createCommentVNode("",!0)]),l.createElementVNode("div",{class:"k-filter__value",title:(L=t.value)==null?void 0:L.toString()},[((G=c.value(t.key))==null?void 0:G.dataType)==="date"?(l.openBlock(),l.createElementBlock("div",Oe,[e.simpleDateDisplay?l.createCommentVNode("",!0):(l.openBlock(),l.createBlock(r.unref(C.KSelect),{key:0,modelValue:t.dateRange,"onUpdate:modelValue":i=>t.dateRange=i,size:r.unref(y).ownSize,teleported:!1,clearable:"",disabled:D.value(t),onChange:i=>H(t)},{default:l.withCtx(()=>[(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList(ce.value(t),i=>{var w;return l.openBlock(),l.createBlock(r.unref(C.KOption),{key:i.value,label:(w=r.unref(b))==null?void 0:w(`filter.${i.label}`),value:i.value,disabled:(t.logic==="after"||t.logic==="before")&&i.value==="range"},null,8,["label","value","disabled"])}),128))]),_:2},1032,["modelValue","onUpdate:modelValue","size","disabled","onChange"])),l.createVNode(r.unref(De.KDatePicker),{modelValue:t.value,"onUpdate:modelValue":i=>t.value=i,type:t.dateType,teleported:!1,size:r.unref(y).ownSize,format:c.value(t.key).format??c.value(t.key).valueFormat,"value-format":c.value(t.key).valueFormat??e.dateFormat,clearable:"",disabled:de.value(t),onChange:i=>{Y(i,t)}},null,8,["modelValue","onUpdate:modelValue","type","size","format","value-format","disabled","onChange"])])):((J=c.value(t.key))==null?void 0:J.dataType)==="time"?(l.openBlock(),l.createBlock(r.unref(Le.ElTimePicker),{key:1,modelValue:t.value,"onUpdate:modelValue":i=>t.value=i,size:r.unref(y).elSize,"is-range":"",clearable:"",teleported:!1,format:c.value(t.key).format??c.value(t.key).valueFormat,"value-format":c.value(t.key).valueFormat??e.timeFormat,onChange:i=>{Y(i,t)}},null,8,["modelValue","onUpdate:modelValue","size","format","value-format","onChange"])):((Q=c.value(t.key))==null?void 0:Q.multiple)==="tree-select"?(l.openBlock(),l.createBlock(r.unref(_e.KTreeSelect),{key:2,modelValue:t.value,"onUpdate:modelValue":i=>t.value=i,"node-key":"value",indent:10,data:((X=c.value(t.key))==null?void 0:X.options)??[],"show-checkbox":"","collapse-tags":"","max-collapse-tags":3,multiple:"",teleported:!1,clearable:"",onChange:()=>{U(t,"tree-select",c.value(t.key).options)}},null,8,["modelValue","onUpdate:modelValue","data","onChange"])):(I=(Z=c.value(t.key))==null?void 0:Z.options)!=null&&I.length?(l.openBlock(),l.createBlock(r.unref(C.KSelect),{key:3,modelValue:t.value,"onUpdate:modelValue":i=>t.value=i,class:V.normalizeClass({"is-multiple":(ee=c.value(t.key))==null?void 0:ee.multiple}),size:r.unref(y).ownSize,teleported:!1,disabled:D.value(t),"collapse-tags":"","max-collapse-tags":3,multiple:((le=c.value(t.key))==null?void 0:le.multiple)===!0||((ae=c.value(t.key))==null?void 0:ae.multiple)==="select",clearable:"",onChange:()=>{U(t,"select",c.value(t.key).options)}},{default:l.withCtx(()=>{var i;return[(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList((i=c.value(t.key))==null?void 0:i.options,w=>(l.openBlock(),l.createBlock(r.unref(C.KOption),{key:w.label,label:w.label,value:w.value},null,8,["label","value"]))),128))]}),_:2},1032,["modelValue","onUpdate:modelValue","class","size","disabled","multiple","onChange"])):(l.openBlock(),l.createBlock(r.unref(Ce.KInput),{key:4,modelValue:t.value,"onUpdate:modelValue":i=>t.value=i,size:r.unref(y).ownSize,disabled:D.value(t),clearable:"",onChange:()=>{U(t,"input")}},null,8,["modelValue","onUpdate:modelValue","size","disabled","onChange"]))],8,Me),l.createElementVNode("i",{class:"close-icon",onClick:i=>pe(f)},[l.createVNode(r.unref(Fe.default))],8,$e)],8,xe)}),128)),l.createElementVNode("div",{class:V.normalizeClass(["k-filter__operate",r.unref(y).ownSize==="sm"?"text-sm":"text-base"])},[l.createElementVNode("div",je,[l.createElementVNode("span",{onClick:a[1]||(a[1]=t=>A())},[l.createVNode(r.unref(qe.default)),l.createTextVNode(" "+V.toDisplayString((s=r.unref(b))==null?void 0:s("filter.addCondition")),1)])]),l.createElementVNode("div",He,[l.createElementVNode("span",Pe,V.toDisplayString((g=r.unref(b))==null?void 0:g("filter.aboveCondition"))+"：",1),l.createVNode(r.unref(C.KSelect),{modelValue:B.value,"onUpdate:modelValue":a[2]||(a[2]=t=>B.value=t),size:r.unref(y).ownSize,disabled:O.value,teleported:!1},{default:l.withCtx(()=>{var t,f;return[l.createVNode(r.unref(C.KOption),{label:(t=r.unref(b))==null?void 0:t("filter.anyOne"),value:0},null,8,["label"]),l.createVNode(r.unref(C.KOption),{label:(f=r.unref(b))==null?void 0:f("filter.all"),value:1},null,8,["label"])]}),_:1},8,["modelValue","size","disabled"]),l.createVNode(r.unref(ne.KButton),{size:r.unref(y).ownSize,main:"",onClick:ye},{default:l.withCtx(()=>{var t;return[l.createTextVNode(V.toDisplayString((t=r.unref(b))==null?void 0:t("filter.query")),1)]}),_:1},8,["size"])])],2)])]}),_:3},8,["popper-class"])],2)}}});exports.default=Ye;
