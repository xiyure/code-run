"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),le=require("../../node_modules/dayjs/dayjs.min.cjs"),be=require("../input/index.cjs"),we=require("../tree_select/index.cjs"),b=require("../select/index.cjs"),Ce=require("../cascader/index.cjs"),ae=require("../button/index.cjs"),_e=require("../date_picker/index.cjs"),B=require("../../constant/filter_data.cjs"),L=require("../../utils/utils.cjs");require("../../node_modules/resize-observer-polyfill/dist/ResizeObserver.es.cjs");require("../../node_modules/sortablejs/modular/sortable.esm.cjs");require("../../node_modules/culori/src/index.cjs");const Be=require("../../hooks/use_size.cjs"),De=require("../../hooks/use_locale.cjs"),ze=require("../../node_modules/lodash-es/cloneDeep.cjs"),Se=require("../../node_modules/ksw-vue-icon/es/icons/base/clearDate.cjs"),Te=require("../../node_modules/ksw-vue-icon/es/icons/base/add.cjs"),Ae=require("../../node_modules/ksw-vue-icon/es/icons/base/close.cjs"),te=require("../../node_modules/ksw-vue-icon/es/icons/base/filter-fill.cjs"),ne=require("../../node_modules/ksw-vue-icon/es/icons/base/filter.cjs"),Fe=require("../../node_modules/element-plus/es/components/time-picker/index.cjs"),Le={key:1},Ne={class:"k-filter__content"},qe={class:"k-filter__header"},Ee=["title"],Ke={class:"k-filter__condition"},xe={class:"k-filter__logic"},Re=["title"],Ue={key:0,class:"k-filter__date-box"},Me=["onClick"],Oe={class:"k-filer__operate-left"},$e={class:"k-filer__operate-right"},je={class:"select-label"},He=e.defineComponent({name:"KFilter",__name:"filter",props:{data:{default:()=>[]},options:{},border:{type:Boolean,default:!0},size:{},childrenField:{default:"children"},filterKey:{default:"title"},defaultCondition:{},remote:{type:[Boolean,Array]},dateFormat:{},timeFormat:{},ignoreCase:{type:Boolean,default:!1},maxNumber:{},simpleDateDisplay:{type:Boolean,default:!0}},emits:["confirm","clear","show","hide"],setup(oe,{expose:re,emit:ue}){const c=oe,p=Be.useSize(c),N=e.ref(""),D=ue,{t:m}=De.useLocale(),k=e.ref([]),C=e.ref(0),z=e.computed(()=>L.treeDataToArray(ze.default(c.options),"group")),i=e.computed(()=>function(l){var n;return(n=z.value)==null?void 0:n.find(o=>o[c.filterKey]===l)}),R=e.computed(()=>function(l){var d;const a=(d=z.value)==null?void 0:d.find(f=>f[c.filterKey]===l.key),{dataType:n="string",logics:o}=a??{},{logicList:r=[]}=B.logicOptions.find(f=>f.type===n)??{},u=r.map(f=>f.logic);if(!o)return u;const v=Array.isArray(o)?o:[o],t=new Set(u);return v.filter(f=>t.has(f))}),se=e.computed(()=>function(l){if(l.logic==="equal")return B.dateTypeOptions;const a=["past-seven-days","past-thirty-days"];return B.dateTypeOptions.filter(n=>!a.includes(n.value))}),q=e.computed(()=>k.value.some(l=>l.key&&l.logic&&(l.value||["empty","nonEmpty"].includes(l.logic)))),_=e.computed(()=>function(l){const a=["empty","nonEmpty"];return!l.logic||a.includes(l.logic)}),ie=e.computed(()=>function(l){const a=["date","range"];return _.value(l)||!a.includes(l.dateRange)}),U=e.computed(()=>{const l=k.value.map(a=>a.key);return Array.isArray(c.remote)&&c.remote.some(a=>l.includes(a))});e.watch(()=>U.value,l=>{l&&(C.value=1)},{immediate:!0}),ce();function ce(){var a,n,o;C.value=((a=c.defaultCondition)==null?void 0:a.filterRule)??0;const{conditionList:l=[]}=c.defaultCondition??{};if(!Array.isArray(l)||!l.length){S();return}for(let r=0;r<l.length;r++)S();for(let r=0;r<k.value.length;r++){const u=k.value[r],{title:v,logic:t,value:d,showValue:f,key:w,handler:g}=l[r];u.title=v.split("-"),u.logic=t,u.value=d,u.showValue=f,u.key=w,u.handler=g;const h=(n=z.value)==null?void 0:n.find(F=>F[c.filterKey]===w);u._allowSelectLogic=!((o=h.options)!=null&&o.length),h.dataType==="date"&&!Array.isArray(d)?(u.dateRange="date",u.dateType="datetime"):h.dataType==="date"&&Array.isArray(d)&&(u.dateRange="range",u.dateType="datetimerange")}}function S(){const l={title:[],logic:"",showValue:"",value:"",key:"",handler:null,dateRange:"date",dateType:"datetime"};k.value.push(l)}function de(l){l===0&&k.value.length===1?E(!1):k.value.splice(l,1)}function E(l=!0){return k.value.length=0,S(),l?K():{}}function fe(){const{conditionInfo:l,data:a}=K();D("confirm",l,a??[])}function K(l){const a=Array.isArray(l)?l:c.data,n=O();if(c.remote===!0||n.conditionList.length===0)return{conditionInfo:n,data:a};const o=a==null?void 0:a.filter(r=>C.value===0?n.conditionList.some(u=>M(u,r)):n.conditionList.every(u=>M(u,r)));return{conditionInfo:n,data:o??[]}}function M(l,a){var u,v,t;if(pe().has(l.key))return!0;const o=(u=z.value)==null?void 0:u.find(d=>d[c.filterKey]===l.key);if(!o||!o[c.filterKey])return!1;const r=a[o[c.filterKey]];return Array.isArray(l.value)?i.value(l.key).dataType==="date"||i.value(l.key).dataType==="time"?(t=l.handler)==null?void 0:t.call(l,r,l.value):l.value.some(d=>{var f;return(f=l.handler)==null?void 0:f.call(l,r,d,c.ignoreCase)}):(v=l.handler)==null?void 0:v.call(l,r,l.value,c.ignoreCase)}function O(){const l=["empty","nonEmpty"];return{conditionList:k.value.filter(n=>n.key&&n.logic&&(L.isValid(n.value)||l.includes(n.logic))).map(n=>{var o;return{title:n.title.join(" - "),logic:n.logic,key:n.key,showValue:n.showValue,value:n.value,handler:n.handler,config:((o=c.options)==null?void 0:o.find(r=>r[c.filterKey]===n.key))??[]}}),filterRule:C.value}}function pe(){return Array.isArray(c.remote)?new Map(c.remote.map((l,a)=>[l,a])):new Map}function ye(l){var f,w;const a=k.value[l];(f=i.value(a.key))!=null&&f.multiple&&(a.value=[]);const n=a.title??[];if(n.length===0){a.key=null,a.logic="equal",a.value="",a.showValue="";return}let o=c.options??[],r;for(const g of n)r=o==null?void 0:o.find(h=>h.title===g),o=(r==null?void 0:r.group)??[];a.key=r==null?void 0:r[c.filterKey];const u=(w=i.value(a.key))==null?void 0:w.dataType,v=u===void 0||u==="string"?"contain":"equal",t=R.value(a);a.logic=t.includes(v)?v:t[0],c.simpleDateDisplay&&(a.dateType="datetimerange");const d=B.logicOptions.find(g=>g.type===((r==null?void 0:r.dataType)||"string"));if(d){const g=d.logicList.find(h=>h.logic===a.logic);a.handler=(g==null?void 0:g.handler)??null}ve(a),a._allowSelectLogic=!0}function ve(l){const{dataType:a,valueFormat:n=c.timeFormat}=i.value(l.key)??{};if(a!=="time"){l.value="",l.showValue="";return}const o=new Date,r=L.formatterDate([new Date(o.getFullYear(),o.getMonth(),o.getDate()),o],n);l.value=r,l.showValue=r.join(" - ")}function ge(l){var r;(l.logic==="after"||l.logic==="before")&&l.dateType==="datetimerange"&&(l.dateType="datetime",l.dateRange="date");const a=((r=i.value(l.key))==null?void 0:r.dataType)??"string",n=B.logicOptions.find(u=>u.type===a);if(!n)return;_.value(l)&&(l.value="",l.showValue="");const o=n.logicList.find(u=>u.logic===l.logic);l.handler=(o==null?void 0:o.handler)??null,a==="date"&&ke(l)}function ke(l){if(_.value(l)){l.value="",l.showValue="";return}$(l)}function $(l){var r;he(l);let a=Array.isArray(l.value)?"":l.value;switch(l.dateRange){case"range":a=["",""];break;case"today":a=y(0);break;case"tomorrow":a=y(1);break;case"yesterday":a=y(-1);break;case"current-week":a=[y(-T()+1),y(7-T(),!0)];break;case"last-week":a=[y(-T()-6),y(-T(),!0)];break;case"current-month":a=[y(-A()+1),y(j()-A(),!0)];break;case"last-month":a=[y(-A()-j(!0)+1),y(-A(),!0)];break;case"past-seven-days":a=[y(-7),y(-1,!0)];break;case"past-thirty-days":a=[y(-30),y(-1,!0)];break}const n=["current-week","last-week","current-month","last-month"],o=((r=i.value(l.key))==null?void 0:r.valueFormat)??c.dateFormat;l.dateType==="datetime"&&n.includes(l.dateRange)?l.showValue=l.value=P(a,o):(l.value=P(a,o),l.showValue=Array.isArray(l.value)?l.value.join(" - "):l.value)}function y(l,a=!1){const n=new Date,o=new Date(n);return o.setDate(o.getDate()+l),a?o.setHours(23,59,59,0):o.setHours(0,0,0,0),o}function T(){return new Date().getDay()}function A(){return new Date().getDate()}function j(l=!1){const a=new Date().getMonth()+1,n=l?a-1:a,o=[1,3,5,7,8,10,12],r=[4,6,9,11];if(o.includes(n))return 31;if(r.includes(n))return 30;const u=new Date().getFullYear();return u%4===0&&u%100!==0||u%400===0?29:28}function he(l){if(l.logic==="equal"){const a=["date","today","tomorrow","yesterday"];l.dateType=a.includes(l.dateRange)?"datetime":"datetimerange"}else if(l.logic==="after"||l.logic==="before"){const a=["range"];l.dateType=a.includes(l.dateRange)?"datetimerange":"datetime"}}function x(l,a,n){if(a==="input")l.showValue=l.value;else if(a==="select"){const o=Array.isArray(l.value)?l.value:[l.value],r=new Set(o);l.showValue=(n??[]).filter(u=>r.has(u.value)).map(u=>u.label).join(", ")}else if(a==="tree-select"){if(!Array.isArray(n)||!Array.isArray(l.value))return;l.showValue=L.getDataByTree(n,l.value,"value","children").map(o=>o.label).join(", ")}}function H(l,a){a.showValue=Array.isArray(l)?l.join(" - "):l}function P(l,a){return a?Array.isArray(l)?l.map(n=>le.default(n).format(a)):le.default(l).format(a):l}function me(){D("show")}function Ve(){D("hide")}return re({filter:K,clearFilter:E,getConditionInfo:O}),(l,a)=>{const n=e.resolveComponent("k-popover");return e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(["k-filter",{"text-sm":e.unref(p).ownSize==="sm","text-base":e.unref(p).ownSize!=="sm"}])},[e.createVNode(n,{trigger:"click",width:"auto",teleported:!1,placement:"bottom-end","popper-class":N.value,onBeforeEnter:a[3]||(a[3]=()=>N.value="k-filter-popper__enter"),onBeforeLeave:a[4]||(a[4]=()=>N.value="k-filter-popper__leave"),onShow:me,onHide:Ve},{reference:e.withCtx(()=>[e.renderSlot(l.$slots,"reference",{hasConfigCondition:q.value},()=>[l.border?(e.openBlock(),e.createBlock(e.unref(ae.KButton),{key:0,size:e.unref(p).ownSize},{default:e.withCtx(()=>[q.value?(e.openBlock(),e.createBlock(e.unref(te.default),{key:1,color:"#2882FF"})):(e.openBlock(),e.createBlock(e.unref(ne.default),{key:0}))]),_:1},8,["size"])):(e.openBlock(),e.createElementBlock("span",Le,[q.value?(e.openBlock(),e.createBlock(e.unref(te.default),{key:1,color:"#2882FF"})):(e.openBlock(),e.createBlock(e.unref(ne.default),{key:0}))]))])]),default:e.withCtx(()=>{var o,r,u,v;return[e.createElementVNode("div",Ne,[e.createElementVNode("div",qe,[e.createElementVNode("span",{class:e.normalizeClass([e.unref(p).ownSize==="sm"?"text-base":"text-lg","font-bold"])},e.toDisplayString((o=e.unref(m))==null?void 0:o("filter.advancedFilter")),3),e.createElementVNode("span",{class:e.normalizeClass(e.unref(p).ownSize==="sm"?"text-sm":"text-base"),onClick:a[0]||(a[0]=()=>{E(),D("clear")})},[e.createVNode(e.unref(Se.default)),e.createTextVNode(" "+e.toDisplayString((r=e.unref(m))==null?void 0:r("filter.clearAll")),1)],2)]),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(k.value,(t,d)=>{var f,w,g,h,F,Y,W,G,J,Q,X,Z,I,ee;return e.openBlock(),e.createElementBlock("div",{key:d,title:(f=t.title)==null?void 0:f.join("/"),class:"k-filter__item"},[e.createElementVNode("div",Ke,[e.createVNode(e.unref(Ce.KCascader),{modelValue:t.title,"onUpdate:modelValue":s=>t.title=s,teleported:!1,size:e.unref(p).ownSize,options:l.options,props:{label:"title",value:"title",children:c.childrenField},clearable:"",onChange:s=>ye(d)},null,8,["modelValue","onUpdate:modelValue","size","options","props","onChange"])]),e.createElementVNode("div",xe,[!(((w=i.value(t.key))==null?void 0:w.dataType)==="date"&&l.simpleDateDisplay)&&!((g=i.value(t.key))!=null&&g.multiple)&&((h=i.value(t.key))==null?void 0:h.dataType)!=="time"?(e.openBlock(),e.createBlock(e.unref(b.KSelect),{key:0,modelValue:t.logic,"onUpdate:modelValue":s=>t.logic=s,size:e.unref(p).ownSize,teleported:!1,clearable:"",disabled:t._allowSelectLogic===!1,onChange:s=>ge(t)},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(R.value(t),s=>{var V;return e.openBlock(),e.createBlock(e.unref(b.KOption),{key:s,label:(V=e.unref(m))==null?void 0:V(`filter.${s}`),value:s},null,8,["label","value"])}),128))]),_:2},1032,["modelValue","onUpdate:modelValue","size","disabled","onChange"])):e.createCommentVNode("",!0)]),e.createElementVNode("div",{class:"k-filter__value",title:(F=t.value)==null?void 0:F.toString()},[((Y=i.value(t.key))==null?void 0:Y.dataType)==="date"?(e.openBlock(),e.createElementBlock("div",Ue,[l.simpleDateDisplay?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(e.unref(b.KSelect),{key:0,modelValue:t.dateRange,"onUpdate:modelValue":s=>t.dateRange=s,size:e.unref(p).ownSize,teleported:!1,clearable:"",disabled:_.value(t),onChange:s=>$(t)},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(se.value(t),s=>{var V;return e.openBlock(),e.createBlock(e.unref(b.KOption),{key:s.value,label:(V=e.unref(m))==null?void 0:V(`filter.${s.label}`),value:s.value,disabled:(t.logic==="after"||t.logic==="before")&&s.value==="range"},null,8,["label","value","disabled"])}),128))]),_:2},1032,["modelValue","onUpdate:modelValue","size","disabled","onChange"])),e.createVNode(e.unref(_e.KDatePicker),{modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,type:t.dateType,teleported:!1,size:e.unref(p).ownSize,format:i.value(t.key).format??i.value(t.key).valueFormat,"value-format":i.value(t.key).valueFormat??l.dateFormat,clearable:"",disabled:ie.value(t),onChange:s=>{H(s,t)}},null,8,["modelValue","onUpdate:modelValue","type","size","format","value-format","disabled","onChange"])])):((W=i.value(t.key))==null?void 0:W.dataType)==="time"?(e.openBlock(),e.createBlock(e.unref(Fe.ElTimePicker),{key:1,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,size:e.unref(p).elSize,"is-range":"",clearable:"",teleported:!1,format:i.value(t.key).format??i.value(t.key).valueFormat,"value-format":i.value(t.key).valueFormat??l.timeFormat,onChange:s=>{H(s,t)}},null,8,["modelValue","onUpdate:modelValue","size","format","value-format","onChange"])):((G=i.value(t.key))==null?void 0:G.multiple)==="tree-select"?(e.openBlock(),e.createBlock(e.unref(we.KTreeSelect),{key:2,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,"node-key":"value",indent:10,data:((J=i.value(t.key))==null?void 0:J.options)??[],"show-checkbox":"","collapse-tags":"","max-collapse-tags":3,multiple:"",teleported:!1,clearable:"",onChange:()=>{x(t,"tree-select",i.value(t.key).options)}},null,8,["modelValue","onUpdate:modelValue","data","onChange"])):(X=(Q=i.value(t.key))==null?void 0:Q.options)!=null&&X.length?(e.openBlock(),e.createBlock(e.unref(b.KSelect),{key:3,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,class:e.normalizeClass({"is-multiple":(Z=i.value(t.key))==null?void 0:Z.multiple}),size:e.unref(p).ownSize,teleported:!1,disabled:_.value(t),"collapse-tags":"","max-collapse-tags":3,multiple:((I=i.value(t.key))==null?void 0:I.multiple)===!0||((ee=i.value(t.key))==null?void 0:ee.multiple)==="select",clearable:"",onChange:()=>{x(t,"select",i.value(t.key).options)}},{default:e.withCtx(()=>{var s;return[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList((s=i.value(t.key))==null?void 0:s.options,V=>(e.openBlock(),e.createBlock(e.unref(b.KOption),{key:V.label,label:V.label,value:V.value},null,8,["label","value"]))),128))]}),_:2},1032,["modelValue","onUpdate:modelValue","class","size","disabled","multiple","onChange"])):(e.openBlock(),e.createBlock(e.unref(be.KInput),{key:4,modelValue:t.value,"onUpdate:modelValue":s=>t.value=s,size:e.unref(p).ownSize,disabled:_.value(t),clearable:"",onChange:()=>{x(t,"input")}},null,8,["modelValue","onUpdate:modelValue","size","disabled","onChange"]))],8,Re),e.createElementVNode("i",{class:"close-icon",onClick:s=>de(d)},[e.createVNode(e.unref(Ae.default))],8,Me)],8,Ee)}),128)),e.createElementVNode("div",{class:e.normalizeClass(["k-filter__operate",e.unref(p).ownSize==="sm"?"text-sm":"text-base"])},[e.createElementVNode("div",Oe,[e.createElementVNode("span",{onClick:a[1]||(a[1]=t=>S())},[e.createVNode(e.unref(Te.default)),e.createTextVNode(" "+e.toDisplayString((u=e.unref(m))==null?void 0:u("filter.addCondition")),1)])]),e.createElementVNode("div",$e,[e.createElementVNode("span",je,e.toDisplayString((v=e.unref(m))==null?void 0:v("filter.aboveCondition"))+"：",1),e.createVNode(e.unref(b.KSelect),{modelValue:C.value,"onUpdate:modelValue":a[2]||(a[2]=t=>C.value=t),size:e.unref(p).ownSize,disabled:U.value,teleported:!1},{default:e.withCtx(()=>{var t,d;return[e.createVNode(e.unref(b.KOption),{label:(t=e.unref(m))==null?void 0:t("filter.anyOne"),value:0},null,8,["label"]),e.createVNode(e.unref(b.KOption),{label:(d=e.unref(m))==null?void 0:d("filter.all"),value:1},null,8,["label"])]}),_:1},8,["modelValue","size","disabled"]),e.createVNode(e.unref(ae.KButton),{size:e.unref(p).ownSize,main:"",onClick:fe},{default:e.withCtx(()=>{var t;return[e.createTextVNode(e.toDisplayString((t=e.unref(m))==null?void 0:t("filter.query")),1)]}),_:1},8,["size"])])],2)])]}),_:3},8,["popper-class"])],2)}}});exports.default=He;
